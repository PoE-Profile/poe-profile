<?php

namespace App\Parse_mods;


class Jewels
{
    public $jewel_slots = [
            // 0
            [
                'location' => 'Marauder',
                'slot' => [],
                'id' => 26725,
                'radius' => null,
                'nodes_in_radius' => [
                    'Small' => [22285, 55649, 44429, 53118, 62363, 38508, 37326, 48109, 63723, 62429, 53793, 62017, 33287, 55676],
                    'Medium' => [5233, 7082, 4336, 62042, 25682, 20018, 49571, 57953, 30380, 59928, 46127, 34130, 39786, 35663, 10282, 10542, 61868, 27166, 27195, 61999, 7399, 59861, 40653, 62108, 63422],
                    'Large' => [28311, 49415, 33082, 12407, 23038, 6113, 9976, 4940, 20966, 16703, 6446, 2550, 38777, 2454, 14606, 60169, 6718, 31928, 32482, 31033],
                ] 
            ],
            // 1
            [
                'location' => 'Templar_Witch',
                'slot' => [],
                'id' => 36634,
                'radius' => null,
                'nodes_in_radius' => [
                    'Small' => [7388, 47251, 21330, 47312, 36542],
                    'Medium' => [10490, 33199, 55866, 45317, 60398, 39648, 17821, 14151, 31875, 4397, 37569, 36774, 17579, 21934],
                    'Large' => [63965, 35724, 13009, 53757, 33783, 11420, 4184, 34661, 18866, 739, 1957, 33296, 57264, 22473],
                ] 
            ],
            // 2
            [
                'location' => 'Shadow_Ranger',
                'slot' => [],
                'id' => 33989,
                'radius' => null,
                'nodes_in_radius' => [
                    'Small' => [63795, 6538, 49978, 39861, 24496, 34907, 28424, 45067, 54974, 54574, 59605, 35296, 51235, 1427, 18707],
                    'Medium' => [58968, 9355, 45838, 8640, 59370, 45035, 465, 41536, 62712, 41250, 38662],
                    'Large' => [65033, 10017, 38344, 50338, 4011, 20953, 45202],
                ] 
            ],
            // 3
            [
                'location' => 'Witch_Shadow',
                'slot' => [],
                'id' => 41263,
                'radius' => null,
                'nodes_in_radius' => [
                    'Small' => [23540, 31137, 35737, 47471, 45680, 25237, 10835, 51923, 48778, 61320, 63799, 55247, 18865, 11334],
	                'Medium' => [15549, 17788, 38807, 5607, 61547, 64501, 37671],
                    'Large' => [27659, 8948, 32210, 21678],
                ]
            ],
            // 4
            [
                'location' => 'Ranger',
                'slot' => [],
                'id' => 60735,
                'radius' => null,
                'nodes_in_radius' => [
                    'Small' => [64235, 37619, 24133, 5616, 20807, 59220, 9469, 65502, 57080, 42104, 49621, 14292, 16079, 48614, 21758, 63843, 38348, 38072, 19858],
                    'Medium' => [12412, 36221, 9206, 41866, 45491, 7085, 1201, 31508, 1571, 6654, 36287],
                    'Large' => [12412, 60942, 1529, 39718],
                ] 
            ],
            // 5
            [
                'location' => 'Shadow',
                'slot' => [],
                'id' => 61834,
                'radius' => null,
                'nodes_in_radius' => [
                    'Small' => [18182, 56295, 46277, 3314, 42443, 21893, 25260, 27788, 40362, 13885, 7112, 53213, 27656, 63228, 42804, 49308, 62177, 25411, 3537, 58244, 4399],
                    'Medium' => [24050, 11018, 60259, 798, 46408, 47484],
                    'Large' => [3656, 53456, 49900, 28012],
                ] 
            ],
            // 6
            [
                'location' => 'Scion_Bottom',
                'slot' => [],
                'id' => 31683,
                'radius' => null,
                'nodes_in_radius' => [
                    'Small' => [60532, 48828, 62662, 17674, 13782, 45887, 20310, 7903, 33508, 36881, 35503, 19144, 25732, 1696, 63933, 16167, 24472, 22893, 53042, 23122, 43162, 39773, 62103],
                    'Medium' => [12702, 19939, 15144, 34062, 13344, 918, 28330, 41967, 17546, 21634, 35179, 9009, 19506],
                    'Large' => [46578, 10829, 42583, 15073, 13714, 65167, 32091],
                ] 
            ],
            // 7
            [
                'location' => 'Duelist_Marauder',
                'slot' => [],
                'id' => 28475,
                'radius' => null,
                'nodes_in_radius' => [
                    'Small' => [57061, 49178, 30733, 29292, 27718, 12809],
                    'Medium' => [46578, 28084, 43015, 26496, 40867, 43374, 22061, 5289, 31080, 6981, 50904, 22627],
                    'Large' => [15868, 36047, 50264, 16380, 59494, 42911, 39211, 13714, 65167, 33988, 31628, 476, 30691],
                ] 
            ],
            // 8
            [
                'location' => 'Scion_Left',
                'slot' => [],
                'id' => 6230,
                'radius' => null,
                'nodes_in_radius' => [
                    'Small' => [55373, 38048, 26740, 55906, 63976, 40126, 3359, 15400, 7614, 13191, 1006, 62662, 17674, 13782, 2151, 22497, 63845, 8643, 5560, 51291, 38450, 37690, 48423, 6204],
                    'Medium' => [12702, 15073, 33479,16775, 48828, 45887, 20310, 33508, 62103, 15144, 37078, 54267, 43133, 23185, 27308, 1609, 4972],
                    'Large' => [10490, 33199, 22473, 14211, 42731, 11430, 46910, 65034, 62021, 42583, 19939, 25732, 1696, 63933],
                ] 
            ],
            // 9
            [
                'location' => 'Scion_Right',
                'slot' => [],
                'id' => 48768,
                'radius' => null,
                'nodes_in_radius' => [
                    'Small' => [15144, 35179, 60532, 9009, 34062, 13344, 8742, 918, 28221, 24643, 47062, 56153, 11688, 45456, 33545, 28574, 61875, 19287, 49379, 18033, 45175, 18359, 34306, 21973, 22497, 63845, 8643],
                    'Medium' => [46092, 37078, 57736, 7594, 65097, 2151, 5560, 51291, 37690, 48828, 62103, 39773, 40100, 34579, 30471, 19506],
                    'Large' => [51786, 20812, 6534, 8348, 57984, 60204, 60090, 13322, 14182, 11430, 42731, 24472, 22893, 53042],
                ] 
            ],
            // 10
            [
                'location' => 'Ranger_Duelist',
                'slot' => [],
                'id' => 34483,
                'radius' => null,
                'nodes_in_radius' => [
                    'Small' => [49806, 2355, 53558, 11497, 238, 5950, 5262, 49270, 24691, 46292, 18402, 8930, 42041],
                    'Medium' => [39725, 63649, 24377, 56803, 62694, 10829, 6580, 11651, 57900],
                    'Large' => [16167, 32091, 41967, 17546, 52904, 48807, 45227, 50306, 35568],
                ] 
            ],
            // 11
            [
                'location' => 'Templar_Witch2',
                'slot' => [],
                'id' => 7960,
                'radius' => null,
                'nodes_in_radius' => [
                    'Small' => [36678, 4977, 17806, 20987, 52502, 39841, 6250, 14674, 30767, 56066, 62217, 30926, 20844, 63944],
                    'Medium' => [54043, 18663, 31973, 22535, 24229, 22702, 13361, 64395, 5456, 56029, 34157, 54657, 9432, 47949],
                    'Large' => [42760, 40366, 55332, 14021, 35706, 367, 58103, 33864, 23659, 50029, 63447, 21167, 44362, 26620, 56671, 4713, 6245, 29049],
                ] 
            ],
            // 12
            [
                'location' => 'Ranger_Duelist2',
                'slot' => [],
                'id' => 46882,
                'radius' => null,
                'nodes_in_radius' => [
                    'Small' => [6363, 42637, 30030, 26096, 5237, 58854, 40132, 51404, 61327, 57199, 42178],
                    'Medium' => [11811, 37785, 11568, 60887, 49459],
                    'Large' => [48030, 23471, 8566, 34510],
                ] 
            ],
            // 13
            [
                'location' => 'Marauder_Templar2',
                'slot' => [],
                'id' => 55190,
                'radius' => null,
                'nodes_in_radius' => [
                    'Small' => [29353, 63282, 31961, 37501, 56355, 35288, 26712, 21929, 38836, 27137, 44202, 18990, 54667, 42917, 47427],
                    'Medium' => [30547, 15163, 40645, 38023, 39023, 58831, 15678, 23027, 60740, 48282, 16754, 51559, 37639, 11088, 3533, 1593, 64426, 62214, 20832, 20349, 32854],
                    'Large' => [59928, 40766, 11730, 6712, 7374, 65108],
                ] 
            ],
            // 14
            [
                'location' => 'Witch',
                'slot' => [],
                'id' => 61419,
                'radius' => null,
                'nodes_in_radius' => [
                    'Small' => [42795, 15711, 19635, 17790, 53279, 3676, 27386, 16971, 34245, 8302, 20528, 56158, 4367, 32431, 36121, 46469, 17659, 27959, 64864, 25609, 35368],
                    'Medium' => [15331, 19501, 5972, 61264, 49588, 11645, 57362, 55647, 56716, 44184, 29781, 24362, 60388, 33755, 14936, 57278, 44723, 16790, 53493, 1346, 27611, 60554, 32024, 38900, 21075, 38805, 4432, 13753, 7503, 11551, 50472, 63067, 22972, 38176],
                    'Large' => [38176, 49236, 27203, 2260, 35334, 61689, 1031, 7938, 12852, 58604, 30225, 44955, 21958, 61804, 14040, 8624, 13559],
                ] 
            ],
            // 15
            [
                'location' => 'Duelist_Marauder2',
                'slot' => [],
                'id' => 2491,
                'radius' => null,
                'nodes_in_radius' => [
                    'Small' => [34400, 58541, 24772, 26456, 8879, 62319, 18901],
                    'Medium' => [6633, 24721, 14419, 30439, 1252, 30160],
                    'Large' => [14056, 65456, 14930, 12926, 48287, 64587, 5197, 37800, 4378, 29547, 22356, 43514, 57839, 61050],
                ] 
            ],
            // 16
            [
                'location' => 'Duelist',
                'slot' => [],
                'id' => 54127,
                'radius' => null,
                'nodes_in_radius' => [
                    'Small' => [34031, 25324, 19782, 41706, 4833, 37584, 17383, 14813, 58545, 24083, 16544, 18103, 31471, 1325, 29933, 56001, 11859, 17201, 4565, 49971, 49109, 21435, 17566],
                    'Medium' => [36222, 47030, 22423, 3009, 24641, 25456, 49538, 12236, 46730, 43412, 30842, 34666, 36972, 43303, 24865, 44624, 31604, 26023, 8533, 56381, 1909, 8533, 49343, 43413, 3319, 1159, 8544, 49547, 56231, 2392, 11397, 23066],
                    'Large' => [33089, 54268, 36761, 12878, 7063, 44207, 11515, 35362, 10016, 10016, 34513, 1340, 65131, 5065, 25763, 52632, 60002, 30155, 25933, 48438, 18302, 34009, 50360, 28265, 1382],
                ] 
            ],
            // 17
            [
                'location' => 'Shadow_Ranger2',
                'slot' => [],
                'id' => 32763,
                'radius' => null,
                'nodes_in_radius' => [
                    'Small' => [1461, 6797, 23334, 1648, 20127, 31359, 31501, 27962, 59556, 54307, 12401, 56744, 19320, 10843, 33374, 31222, 17206, 21228],
                    'Medium' => [49900, 15021, 28548, 65308, 36225, 49568, 30745, 28503, 19228, 14914, 36287, 15837, 64241, 40743, 55307, 24203, 56807, 33725, 59016, 1405],
                    'Large' => [5802, 15825, 56646, 25511, 4481, 37619, 64235, 24133, 37776, 39447, 37504, 46277],
                ] 
            ],
            // 18
            [
                'location' => 'Templar',
                'slot' => [],
                'id' => 26196,
                'radius' => null,
                'nodes_in_radius' => [
                    'Small' => [60472, 10575, 22420, 15064, 12937, 27575, 34173, 5696, 40508, 35958, 46897, 34171, 401, 11730, 40766, 10031, 36949, 6712, 29199, 37999, 29061, 31462, 52407],
                    'Medium' => [23027, 60740, 26270, 25597, 22313, 62225, 54645, 55993, 30693, 22498, 54694, 60732, 39483, 33435, 60704, 64426, 62214, 27134, 61950, 24677, 60619],
                    'Large' => [20467, 5068, 58402, 57715, 40927, 61308, 15365, 46726, 38516, 31819, 31931, 15631, 1593, 32854, 20349, 20832, 44202, 48282, 16754, 18990, 45378, 14730, 12439, 18135, 10771, 23083, 49939],
                ] 
            ],
            // 19
            [
                'location' => 'Marauder_Templar',
                'slot' => [],
                'id' => 33631,
                'radius' => null,
                'nodes_in_radius' => [
                    'Small' => [64816, 34959, 6884, 27301, 27140, 15405, 33740, 34906, 24256, 4300, 65159, 31520, 63635, 11190],
                    'Medium' => [41026, 35910, 46910, 44606, 39631, 20228, 39916, 35556, 2913, 50862, 3167, 6359],
                    'Large' => [17352, 23456, 42837, 31758, 17251, 29005, 7335, 21413, 27609, 13454, 34363, 65491, 44908, 16756, 9371, 63309, 23881, 9511, 63965, 16775, 65034],
                ] 
            ],
            // 20
            [
                'location' => 'Witch_Shadow2',
                'slot' => [],
                'id' => 21984,
                'radius' => null,
                'nodes_in_radius' => [
                    'Small' => [49605, 22618, 21033, 41027, 4546, 4995, 64239, 22407, 64612, 34882, 7641, 17236, 62577, 60440, 20077, 42436, 39986],
                    'Medium' => [32942, 41476, 19098, 3726, 9055, 40409, 28859, 55571, 12143, 25770, 39814, 11455, 5591, 56075],
                    'Large' => [33310, 62697, 13961, 32710, 32345, 10153, 41635, 4036, 15228, 47306, 27190, 34478, 22115],
                ] 
            ],
        ];

    public function addJewels($jewels)
    {
        foreach ($jewels as $jewel) {
            $this->jewel_slots[$jewel['x']]['slot'] = $jewel;
            if (!array_key_exists('jewels', $jewel['category'])) {
                continue;
            }

            if (isset($jewel['properties'])) {
                $this->jewel_slots[$jewel['x']]['radius'] = $this->jewelRadius($jewel['properties']);
            }
        }

        return array_filter($this->jewel_slots, function ($jewel) {
            return !empty($jewel['slot']);
        });
    }

    public function jewelRadius($props)
    {
        $radius = null;
        foreach ($props as $p) {
            if ($p['name'] == 'Radius') {
                $radius = $p['values'][0][0];
            }
        }
        return $radius;
    }

    public function uniqueJewels($point){
        //filter jewels by type to get only Uniques
        $jewels = array_filter($this->jewel_slots, function($jewel) {
            if (!empty($jewel['slot'])) {
                return $jewel['slot']['frameType'] == 3;
            }
            return false;
        });

        if(count($jewels)) {
            foreach($jewels as $jewel){
                //filter point if its in Radius 
                if (!in_array($point->id, $this->pointsInRadius($jewel))) {
                    continue;
                }

                // Transform % Energy Shield to Armour 200% / Energised Armour jewel
                if(str_contains(str_replace("<<set:MS>><<set:M>><<set:S>>", "", $jewel['slot']['name']), 'Energised Armour')) {
                    for ($i=0; $i < count($point->sd); $i++) { 
                        $point->sd[$i] =  str_replace('Energy Shield', 'Armour', $point->sd[$i]);
                    }
                }

                // Transform % Life to Mana 200% / Healthy Mind jewel
                if(str_contains(str_replace("<<set:MS>><<set:M>><<set:S>>", "", $jewel['slot']['name']), 'Healthy Mind')) {
                    for ($i=0; $i < count($point->sd); $i++) { 
                        $point->sd[$i] =  str_replace('Life', 'Mana', $point->sd[$i]);
                    }
                }

                // Transform % Life to Energy Shield / Energy From Within jewel
                if(str_contains(str_replace("<<set:MS>><<set:M>><<set:S>>", "", $jewel['slot']['name']), 'Energy From Within')) {
                    for ($i=0; $i < count($point->sd); $i++) { 
                        $point->sd[$i] =  str_replace('Life', 'Energy Shield', $point->sd[$i]);
                    }
                }
                
                // Transform Strength to Intelligence / Brute Force Solution jewel
                if(str_contains(str_replace("<<set:MS>><<set:M>><<set:S>>", "", $jewel['slot']['name']), 'Brute Force')) {
                    $point->sd = $this->replaceMod($point->sd, 'Brute');
                }

                // Transform Strength to Dexterity / Fluid Force Solution jewel
                if(str_contains(str_replace("<<set:MS>><<set:M>><<set:S>>", "", $jewel['slot']['name']), 'Fluid Motion')) {
                    $point->sd = $this->replaceMod($point->sd, 'Fluid');
                }

                // Transform Intelligence to Dexterity / Careful Planning jewel
                if(str_contains(str_replace("<<set:MS>><<set:M>><<set:S>>", "", $jewel['slot']['name']), 'Careful Planning')) {
                    $point->sd = $this->replaceMod($point->sd, 'Careful');
                }

                // Transform Intelligence to Strength / Efficient Training jewel
                if(str_contains(str_replace("<<set:MS>><<set:M>><<set:S>>", "", $jewel['slot']['name']), 'Efficient Training')) {
                    $point->sd = $this->replaceMod($point->sd, 'Efficient');
                }
                
                // Transform Dexterity to Intelligence / Fertile Mind jewel
                if(str_contains(str_replace("<<set:MS>><<set:M>><<set:S>>", "", $jewel['slot']['name']), 'Fertile Mind')) {
                    $point->sd  = $this->replaceMod($point->sd, 'Fertile');
                }

                // Transform Strength to Dexterity / Inertia jewel
                if(str_contains(str_replace("<<set:MS>><<set:M>><<set:S>>", "", $jewel['slot']['name']), 'Inertia')) {
                    $point->sd = $this->replaceMod($point->sd, 'Inertia');
                }

                // Transform Melee and Melee Weapon Type to Bow / Lioneye's Fall jewel
                if(str_contains(str_replace("<<set:MS>><<set:M>><<set:S>>", "", $jewel['slot']['name']), "Lioneye's Fall")) {
                    for ($i=0; $i < count($point->sd); $i++) { 
                        $point->sd[$i] =  $this->lioneyesFall($point->sd[$i]);
                    }
                }

                // Transform 50% increased Effect of non-Keystone Passive Skills / Might of the Meek jewel
                if (str_contains(str_replace("<<set:MS>><<set:M>><<set:S>>", "", $jewel['slot']['name']), 'Might of the Meek')) {
                    for ($i = 0; $i < count($point->sd); $i++) {
                        // if Keystone continue
                        if ($point->ks) {
                            continue;
                        }
                        $mod = $point->sd[$i];

                        $modValue = filter_var($mod, FILTER_SANITIZE_NUMBER_INT);
                        $modValue += $modValue * 0.5; 
                        $modName = preg_replace('/\d+/u', '#', $mod);
                        $point->sd[$i] = str_replace('#', round($modValue), $modName);
                    }
                }
                

            }
           
        }
        return $point;
    }

    private function pointsInRadius($jewel){
        if ($jewel['radius'] == 'Small') {
            return $jewel['nodes_in_radius']['Small'];
        }
        if ($jewel['radius'] == 'Medium') {
            return array_merge($jewel['nodes_in_radius']['Small'], $jewel['nodes_in_radius']['Medium']);
        }
        if ($jewel['radius'] == 'Large') {
            return array_merge($jewel['nodes_in_radius']['Small'], $jewel['nodes_in_radius']['Medium'], $jewel['nodes_in_radius']['Large']);
        }

        // if jewel has radius set no null return empty array
        return [];
    }

    private function replaceMod($mods, $jewelName) {
        for ($i = 0; $i < count($mods); $i++) {

            $modName = preg_replace('/\d+/u', '#', $mods[$i]);
            $modValue = filter_var($mods[$i], FILTER_SANITIZE_NUMBER_INT);
            // dd('hey');
            if ($jewelName == 'Efficient') {
                // dump($mods[$i]);
                if ($modName === '+# to Intelligence') {
                    $mods[$i] = str_replace('Intelligence', 'Strength', $mods[$i]);
                }
                if ($modName === '+# to Strength and Intelligence') {
                    $mods[$i] = '+' . ($modValue * 2) . ' to Strength';
                }
                // dump($mods[$i]);
            }
            // dump('zzzz');
            if ($jewelName == 'Inertia') {
                if ($modName === '+# to Dexterity') {
                    $mods[$i] = str_replace('Dexterity', 'Strength', $mods[$i]);
                }
                if ($modName === '+# to Strength and Dexterity') {
                    $mods[$i] = '+' . ($modValue * 2) . ' to Strength';
                }
            }

            if ($jewelName == 'Careful') {
                if ($modName === '+# to Intelligence') {
                    $mods[$i] = str_replace('Intelligence', 'Dexterity', $mods[$i]);
                }
                if ($modName === '+# to Dexterity and Intelligence') {
                    $mods[$i] = '+' . ($modValue * 2) . ' to Dexterity';
                }
            }
            if ($jewelName == 'Fluid') {
                if ($modName === '+# to Strength') {
                    $mods[$i] = str_replace('Strength', 'Dexterity', $mods[$i]);
                }
                if ($modName === '+# to Strength and Dexterity') {
                    $mods[$i] = '+' . ($modValue * 2) . ' to Dexterity';
                }
            }

            if ($jewelName == 'Fertile') {
                if ($modName === '+# to Dexterity') {
                    $mods[$i] = str_replace('Dexterity', 'Intelligence', $mods[$i]);
                }
                if ($modName === '+# to to Dexterity and Intelligence') {
                    $mods[$i] = '+' . ($modValue * 2) . ' to Intelligence';
                }
            }
            if ($jewelName == 'Brute') {
                if ($modName === '+# to Strength') {
                    $mods[$i] = str_replace('Strength', 'Intelligence', $mods[$i]);
                }
                if ($modName === '+# to Strength and Intelligence') {
                    $mods[$i] = '+' . ($modValue * 2) . ' to Intelligence';
                }
            }
        }
        return $mods;
        
    }

    private function lioneyesFall($mod){
        return $mod;
    }
}